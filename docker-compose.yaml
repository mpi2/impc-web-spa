
services:
  proxy-nginx:
    image: nginx:alpine
    depends_on:
      website:
        condition: service_healthy
      searchservice:
        condition: service_healthy
    environment:
      PORT: 8080
    ports:
      - "8080:8080"
    volumes:
      - ./docker-compose/proxy-nginx:/etc/nginx/templates

  website:
    depends_on:
      - searchservice
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SEARCH_SERVICE_ENABLED: true
        API_ROOT: http://localhost:8080

  mongodb:
    image: mongo:8.2-noble
    restart: always
    volumes:
      - ./docker-compose/mongo/init/:/docker-entrypoint-initdb.d
      - ./docker-compose/mongo/init:/home/mongodb
      - ./docker-compose/mongo/mongorestore.sh:/docker-entrypoint-initdb.d/mongorestore.sh
      - ./docker-compose/mongo:/mongo
    environment:
      MONGO_INITDB_ROOT_USERNAME: impc-spa
      MONGO_INITDB_ROOT_PASSWORD: I5dVq9<8f8;5
      MONGO_INITDB_DATABASE: searchDB
      DB_NAME: searchDB

  searchservice:
    image: mousephenotype/impc-search-service:latest
    depends_on:
      - mongodb
    environment:
      XMS: "-Xms1024m"
      XMX: "-Xmx1024m"
      MONGODB_URL: "impc-spa:I5dVq9<8f8;5@mongodb:27017"
      ENVIRONMENT: "aws"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health/readiness"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 20s